name: Release Validation Suite

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to test (e.g., latest, 2.0.0, 2.0.0-beta.1)'
        required: true
        default: 'latest'
      run_ui_tests:
        description: 'Include Admin UI tests'
        type: boolean
        default: true
      run_stress_tests:
        description: 'Include stress tests (adds ~10min)'
        type: boolean
        default: false

env:
  SIGNALK_IMAGE: signalk/signalk-server:${{ github.event.inputs.image_tag }}
  TEST_TIMEOUT: 300000

jobs:
  setup:
    name: Setup Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      image_id: ${{ steps.check.outputs.image_id }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache node_modules
        uses: actions/cache/save@v4
        with:
          path: node_modules
          key: node-modules-${{ github.run_id }}

      - name: Pull and cache Docker image
        id: check
        run: |
          if docker pull ${{ env.SIGNALK_IMAGE }}; then
            IMAGE_ID=$(docker inspect ${{ env.SIGNALK_IMAGE }} --format='{{.Id}}')
            echo "image_id=$IMAGE_ID" >> $GITHUB_OUTPUT
            docker inspect ${{ env.SIGNALK_IMAGE }} --format='Created: {{.Created}}'
            # Save image as tarball for other jobs
            docker save ${{ env.SIGNALK_IMAGE }} -o signalk-image.tar
          else
            echo "::error::Image ${{ env.SIGNALK_IMAGE }} not found"
            exit 1
          fi

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: signalk-image.tar
          retention-days: 1

  test-lifecycle:
    name: Server Lifecycle Tests
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: node-modules-${{ github.run_id }}

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i signalk-image.tar

      - name: Run lifecycle tests
        run: npm run test:lifecycle
        env:
          SIGNALK_IMAGE: ${{ env.SIGNALK_IMAGE }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-lifecycle
          path: reports/

      - name: Cleanup Docker
        if: always()
        run: |
          rm -f signalk-image.tar
          docker system prune -f

  test-plugins:
    name: Plugin Loading Tests
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: node-modules-${{ github.run_id }}

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i signalk-image.tar

      - name: Run plugin tests
        run: npm run test:plugins
        env:
          SIGNALK_IMAGE: ${{ env.SIGNALK_IMAGE }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-plugins
          path: reports/

      - name: Cleanup Docker
        if: always()
        run: |
          rm -f signalk-image.tar
          docker system prune -f

  test-nmea:
    name: NMEA 0183 Tests (TCP + UDP)
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: node-modules-${{ github.run_id }}

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i signalk-image.tar

      - name: Run NMEA tests
        run: npm run test:nmea
        env:
          SIGNALK_IMAGE: ${{ env.SIGNALK_IMAGE }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-nmea
          path: reports/

      - name: Cleanup Docker
        if: always()
        run: |
          rm -f signalk-image.tar
          docker system prune -f

  test-scenarios:
    name: Real-World Scenario Tests
    needs: [setup, test-lifecycle, test-nmea]
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: node-modules-${{ github.run_id }}

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i signalk-image.tar

      - name: Run scenario tests
        run: npm run test:scenarios
        env:
          SIGNALK_IMAGE: ${{ env.SIGNALK_IMAGE }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-scenarios
          path: reports/

      - name: Cleanup Docker
        if: always()
        run: |
          rm -f signalk-image.tar
          docker system prune -f

  test-admin-ui:
    name: Admin UI Tests
    needs: [setup, test-lifecycle, test-plugins]
    if: ${{ github.event.inputs.run_ui_tests == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: node-modules-${{ github.run_id }}

      - name: Install Playwright browsers
        run: npx playwright install chromium

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i signalk-image.tar

      - name: Clean reports directory
        run: npm run clean

      - name: Run Admin UI tests (single container)
        run: npm run test:admin-ui
        env:
          SIGNALK_IMAGE: ${{ env.SIGNALK_IMAGE }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-admin-ui
          path: reports/

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-screenshots
          path: reports/screenshots/

      - name: Cleanup Docker
        if: always()
        run: |
          rm -f signalk-image.tar
          docker system prune -f

  test-auth:
    name: Authentication Tests
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: node-modules-${{ github.run_id }}

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i signalk-image.tar

      - name: Run authentication tests
        run: npm run test:auth
        env:
          SIGNALK_IMAGE: ${{ env.SIGNALK_IMAGE }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-auth
          path: reports/

      - name: Cleanup Docker
        if: always()
        run: |
          rm -f signalk-image.tar
          docker system prune -f

  test-resources:
    name: Resources API Tests
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: node-modules-${{ github.run_id }}

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i signalk-image.tar

      - name: Run resources API tests
        run: npm run test:resources
        env:
          SIGNALK_IMAGE: ${{ env.SIGNALK_IMAGE }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-resources
          path: reports/

      - name: Cleanup Docker
        if: always()
        run: |
          rm -f signalk-image.tar
          docker system prune -f

  test-course:
    name: Course Navigation Tests
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: node-modules-${{ github.run_id }}

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i signalk-image.tar

      - name: Run course navigation tests
        run: npm run test:course
        env:
          SIGNALK_IMAGE: ${{ env.SIGNALK_IMAGE }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-course
          path: reports/

      - name: Cleanup Docker
        if: always()
        run: |
          rm -f signalk-image.tar
          docker system prune -f

  test-ais:
    name: AIS Comprehensive Tests
    needs: [setup, test-nmea]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: node-modules-${{ github.run_id }}

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i signalk-image.tar

      - name: Run AIS comprehensive tests
        run: npm run test:ais
        env:
          SIGNALK_IMAGE: ${{ env.SIGNALK_IMAGE }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-ais
          path: reports/

      - name: Cleanup Docker
        if: always()
        run: |
          rm -f signalk-image.tar
          docker system prune -f

  test-multi-auth:
    name: Multi-User Auth Tests
    needs: [setup, test-auth]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: node-modules-${{ github.run_id }}

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i signalk-image.tar

      - name: Run multi-user auth tests
        run: npm run test:multi-auth
        env:
          SIGNALK_IMAGE: ${{ env.SIGNALK_IMAGE }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-multi-auth
          path: reports/

      - name: Cleanup Docker
        if: always()
        run: |
          rm -f signalk-image.tar
          docker system prune -f

  test-https:
    name: HTTPS/TLS Tests
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: node-modules-${{ github.run_id }}

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i signalk-image.tar

      - name: Run HTTPS/TLS tests
        run: npm run test:https
        env:
          SIGNALK_IMAGE: ${{ env.SIGNALK_IMAGE }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-https
          path: reports/

      - name: Cleanup Docker
        if: always()
        run: |
          rm -f signalk-image.tar
          docker system prune -f

  test-mdns:
    name: mDNS Discovery Tests
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: node-modules-${{ github.run_id }}

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i signalk-image.tar

      - name: Run mDNS discovery tests
        run: npm run test:mdns
        env:
          SIGNALK_IMAGE: ${{ env.SIGNALK_IMAGE }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-mdns
          path: reports/

      - name: Cleanup Docker
        if: always()
        run: |
          rm -f signalk-image.tar
          docker system prune -f

  test-nmea-output:
    name: NMEA Output Validation Tests
    needs: [setup, test-nmea]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: node-modules-${{ github.run_id }}

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i signalk-image.tar

      - name: Run NMEA output tests
        run: npm run test:nmea-output
        env:
          SIGNALK_IMAGE: ${{ env.SIGNALK_IMAGE }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-nmea-output
          path: reports/

      - name: Cleanup Docker
        if: always()
        run: |
          rm -f signalk-image.tar
          docker system prune -f

  test-e2e-flow:
    name: End-to-End Data Flow Tests
    needs: [setup, test-lifecycle, test-nmea]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: node-modules-${{ github.run_id }}

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i signalk-image.tar

      - name: Run end-to-end flow tests
        run: npm run test:e2e-flow
        env:
          SIGNALK_IMAGE: ${{ env.SIGNALK_IMAGE }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-e2e-flow
          path: reports/

      - name: Cleanup Docker
        if: always()
        run: |
          rm -f signalk-image.tar
          docker system prune -f

  test-sustained:
    name: Sustained Load Tests
    needs: [setup, test-scenarios]
    if: ${{ github.event.inputs.run_stress_tests == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: node-modules-${{ github.run_id }}

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i signalk-image.tar

      - name: Run sustained load tests
        run: npm run test:sustained
        env:
          SIGNALK_IMAGE: ${{ env.SIGNALK_IMAGE }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-sustained
          path: reports/

      - name: Cleanup Docker
        if: always()
        run: |
          rm -f signalk-image.tar
          docker system prune -f

  test-stress:
    name: Stress Tests
    needs: [setup, test-scenarios]
    if: ${{ github.event.inputs.run_stress_tests == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: node-modules-${{ github.run_id }}

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i signalk-image.tar

      - name: Run stress tests
        run: npm run test:stress
        env:
          SIGNALK_IMAGE: ${{ env.SIGNALK_IMAGE }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-stress
          path: reports/

      - name: Cleanup Docker
        if: always()
        run: |
          rm -f signalk-image.tar
          docker system prune -f

  generate-report:
    name: Generate Validation Report
    needs: [setup, test-lifecycle, test-plugins, test-nmea, test-auth, test-nmea-output, test-e2e-flow, test-scenarios, test-resources, test-course, test-ais, test-multi-auth, test-https, test-mdns]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: node-modules-${{ github.run_id }}

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: results-*
          path: artifacts/
          merge-multiple: false

      - name: Generate consolidated report
        run: |
          mkdir -p reports
          node scripts/generate-report.js \
            --image="${{ env.SIGNALK_IMAGE }}" \
            --artifacts="artifacts/" \
            --lifecycle="${{ needs.test-lifecycle.result }}" \
            --plugins="${{ needs.test-plugins.result }}" \
            --nmea="${{ needs.test-nmea.result }}" \
            --auth="${{ needs.test-auth.result }}" \
            --nmea-output="${{ needs.test-nmea-output.result }}" \
            --e2e-flow="${{ needs.test-e2e-flow.result }}" \
            --scenarios="${{ needs.test-scenarios.result }}" \
            --resources="${{ needs.test-resources.result }}" \
            --course="${{ needs.test-course.result }}" \
            --ais="${{ needs.test-ais.result }}" \
            --multi-auth="${{ needs.test-multi-auth.result }}" \
            --https="${{ needs.test-https.result }}" \
            --mdns="${{ needs.test-mdns.result }}"

      - name: Upload final report
        uses: actions/upload-artifact@v4
        with:
          name: validation-report-${{ github.event.inputs.image_tag }}
          path: reports/
          retention-days: 90

      - name: Post summary to GitHub
        run: |
          if [ -f reports/summary.md ]; then
            cat reports/summary.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for failures
        if: contains(needs.*.result, 'failure')
        run: |
          echo "::error::One or more test categories failed"
          exit 1

  cleanup:
    name: Cleanup Artifacts
    needs: [generate-report, test-admin-ui, test-stress, test-sustained]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Delete Docker image artifact
        uses: geekyeggo/delete-artifact@v5
        with:
          name: docker-image
          failOnError: false

      - name: Delete intermediate results
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            results-lifecycle
            results-plugins
            results-nmea
            results-scenarios
            results-admin-ui
            results-auth
            results-nmea-output
            results-e2e-flow
            results-sustained
            results-stress
            results-resources
            results-course
            results-ais
            results-multi-auth
            results-https
            results-mdns
          failOnError: false
